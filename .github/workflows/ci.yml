name: CI - Validaci√≥n y Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ========================================================================
  # 1. VALIDAR PYTHON - Sintaxis y linting
  # ========================================================================
  python-lint:
    name: üêç Python Lint & Syntax
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint
    
    - name: Check syntax with flake8
      run: |
        # Detener si hay errores de sintaxis
        flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics
        # Advertencias (no fatal)
        flake8 src tests --count --exit-zero --max-complexity=10 --statistics
    
    - name: Lint with pylint
      run: pylint src --exit-zero --disable=C0111,C0103 --max-line-length=120 || true

  # ========================================================================
  # 2. VALIDAR DOCKERFILE - Estructura y buenas pr√°cticas
  # ========================================================================
  docker-lint:
    name: üê≥ Docker Lint
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Run Dockerfile linter
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
    
    - name: Lint LLM Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: llm_service/Dockerfile

  # ========================================================================
  # 3. VALIDAR YAML - docker-compose, config files
  # ========================================================================
  yaml-lint:
    name: üìã YAML Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install yamllint
      run: pip install yamllint
    
    - name: Validate docker-compose.yml
      run: yamllint -d relaxed docker-compose.yml
    
    - name: Validate config files
      run: |
        yamllint -d relaxed config/config.yaml || true
        yamllint -d relaxed config/exchange.yaml || true
        yamllint -d relaxed config/model_config.yaml || true

  # ========================================================================
  # 4. TESTS - Python tests b√°sicos
  # ========================================================================
  tests:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: ankane/pgvector:latest
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run tests
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: test_user
        DB_PASS: test_pass
        DB_NAME: test_db
      run: |
        pytest tests/ -v --cov=src --cov-report=xml || true
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        fail_ci_if_error: false

  # ========================================================================
  # 5. VALIDAR README - Archivos cr√≠ticos existen
  # ========================================================================
  docs-check:
    name: üìö Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check required files
      run: |
        files=(
          "README.md"
          "docker-compose.yml"
          "Dockerfile"
          "llm_service/Dockerfile"
          "llm_service/models/README.md"
          ".env.example"
        )
        
        for file in "${files[@]}"
        do
          if [ ! -f "$file" ]; then
            echo "‚ùå Archivo faltante: $file"
            exit 1
          fi
          echo "‚úÖ Encontrado: $file"
        done

  # ========================================================================
  # 6. BUILD DOCKER - Verificar que las im√°genes compilam
  # ========================================================================
  docker-build:
    name: üî® Docker Build Check
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build main Dockerfile (no push)
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: email-ai:test
    
    - name: Build LLM Dockerfile (no push)
      uses: docker/build-push-action@v4
      with:
        context: ./llm_service
        file: ./llm_service/Dockerfile
        push: false
        tags: email-ai-llm:test

  # ========================================================================
  # RESUMEN - Status final del workflow
  # ========================================================================
  status:
    name: ‚úÖ Workflow Status
    runs-on: ubuntu-latest
    needs: [python-lint, docker-lint, yaml-lint, tests, docs-check, docker-build]
    if: always()
    
    steps:
    - name: Check workflow status
      run: |
        if [ "${{ needs.python-lint.result }}" == "failure" ] || \
           [ "${{ needs.docker-lint.result }}" == "failure" ] || \
           [ "${{ needs.yaml-lint.result }}" == "failure" ] || \
           [ "${{ needs.tests.result }}" == "failure" ] || \
           [ "${{ needs.docs-check.result }}" == "failure" ] || \
           [ "${{ needs.docker-build.result }}" == "failure" ]; then
          echo "‚ùå Pipeline failed"
          exit 1
        fi
        echo "‚úÖ All checks passed!"
