 Para un proyecto de IA que conteste correos de Outlook/Exchange, necesitas una estructura profesional con archivos de reglas (rules) y flujos de trabajo (workflows). Aqu√≠ te detallo todos los archivos necesarios:

---

## Estructura de Carpetas Recomendada

```
proyecto_email_ai/
‚îú‚îÄ‚îÄ üìÅ config/                    # Configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ config.yaml              # Configuraci√≥n general
‚îÇ   ‚îú‚îÄ‚îÄ exchange.yaml            # Configuraci√≥n Exchange/Outlook
‚îÇ   ‚îî‚îÄ‚îÄ model_config.yaml        # Configuraci√≥n del modelo
‚îÇ
‚îú‚îÄ‚îÄ üìÅ rules/                     # REGLAS DE NEGOCIO
‚îÇ   ‚îú‚îÄ‚îÄ email_rules.yaml         # Reglas de procesamiento de correos
‚îÇ   ‚îú‚îÄ‚îÄ response_rules.yaml      # Reglas de respuesta
‚îÇ   ‚îú‚îÄ‚îÄ security_rules.yaml      # Reglas de seguridad y filtrado
‚îÇ   ‚îî‚îÄ‚îÄ tone_rules.yaml          # Reglas de tono y estilo
‚îÇ
‚îú‚îÄ‚îÄ üìÅ workflows/                 # FLUJOS DE TRABAJO
‚îÇ   ‚îú‚îÄ‚îÄ main_workflow.yaml       # Flujo principal
‚îÇ   ‚îú‚îÄ‚îÄ email_processing.yaml    # Procesamiento de entrada
‚îÇ   ‚îú‚îÄ‚îÄ draft_review.yaml        # Revisi√≥n de borradores
‚îÇ   ‚îî‚îÄ‚îÄ escalation_workflow.yaml # Escalamiento humano
‚îÇ
‚îú‚îÄ‚îÄ üìÅ prompts/                   # PROMPTS DEL SISTEMA
‚îÇ   ‚îú‚îÄ‚îÄ system_prompt.txt        # Prompt base del sistema
‚îÇ   ‚îú‚îÄ‚îÄ email_classifier.txt     # Clasificador de correos
‚îÇ   ‚îú‚îÄ‚îÄ response_generator.txt   # Generador de respuestas
‚îÇ   ‚îî‚îÄ‚îÄ quality_checker.txt      # Verificador de calidad
‚îÇ
‚îú‚îÄ‚îÄ üìÅ data/                      # DATOS
‚îÇ   ‚îú‚îÄ‚îÄ training/                # Datos de entrenamiento
‚îÇ   ‚îú‚îÄ‚îÄ templates/               # Plantillas de respuesta
‚îÇ   ‚îî‚îÄ‚îÄ knowledge_base/          # Base de conocimiento
‚îÇ
‚îú‚îÄ‚îÄ üìÅ src/                       # C√ìDIGO FUENTE
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ exchange_connector.py    # Conexi√≥n Exchange
‚îÇ   ‚îú‚îÄ‚îÄ email_processor.py       # Procesador de correos
‚îÇ   ‚îú‚îÄ‚îÄ ai_responder.py          # M√≥dulo IA
‚îÇ   ‚îî‚îÄ‚îÄ workflow_engine.py       # Motor de workflows
‚îÇ
‚îú‚îÄ‚îÄ üìÅ tests/                     # TESTS
‚îú‚îÄ‚îÄ üìÅ logs/                      # LOGS
‚îú‚îÄ‚îÄ üìÅ docs/                      # DOCUMENTACI√ìN
‚îî‚îÄ‚îÄ requirements.txt
```

---

## Archivos de REGLAS (Rules)

### 1. `rules/email_rules.yaml` - Reglas de Procesamiento

```yaml
# Reglas para decidir qu√© correos procesar
email_processing_rules:

  # Reglas de inclusi√≥n (qu√© procesar)
  inclusion:
    - condition: "asunto contiene ['consulta', 'pregunta', 'solicitud', 'info']"
      priority: high
      action: process
      
    - condition: "remitente dominio es '@empresa.com'"
      priority: medium
      action: process
      
    - condition: "correo es de cliente registrado"
      priority: high
      action: process_with_context

  # Reglas de exclusi√≥n (qu√© ignorar)
  exclusion:
    - condition: "asunto contiene ['spam', 'newsletter', 'no responder']"
      action: ignore
      
    - condition: "remitente est√° en lista_negra"
      action: ignore_and_log
      
    - condition: "correo tiene adjunto ejecutable (.exe, .bat)"
      action: quarantine
      
    - condition: "es correo masivo (bcc) y no es urgente"
      action: draft_only  # Crear borrador pero no enviar

  # Reglas de clasificaci√≥n
  classification:
    urgent:
      - "asunto contiene 'urgente'"
      - "asunto contiene 'incidente'"
      - "marcado como alto prioridad"
      
    sales:
      - "asunto contiene ['presupuesto', 'cotizaci√≥n', 'precio']"
      - "remitente es de √°rea comercial"
      
    support:
      - "asunto contiene ['error', 'problema', 'soporte', 'ayuda']"
      - "remitente es cliente con contrato de soporte"
      
    internal:
      - "remitente dominio interno '@empresa.com'"
```

### 2. `rules/response_rules.yaml` - Reglas de Respuesta

```yaml
# Reglas para generar y enviar respuestas
response_generation_rules:

  # Tiempos de respuesta seg√∫n prioridad
  response_time:
    urgent: "15 minutos"
    high: "2 horas"
    normal: "24 horas"
    low: "48 horas"

  # Reglas de formato
  formatting:
    language: "es-ES"
    max_length: 500  # caracteres
    signature_required: true
    include_greeting: true
    include_closing: true
    
    structure:
      - greeting
      - acknowledgment
      - body
      - action_items
      - closing
      - signature

  # Reglas de contenido prohibido
  content_restrictions:
    forbidden_phrases:
      - "no s√©"
      - "no puedo ayudarte"
      - "eso no es mi problema"
      - "pregunta a otra persona"
      
    required_when:
      pricing_inquiry: "incluir disclaimer legal"
      technical_issue: "incluir n√∫mero de ticket"
      complaint: "ofrecer disculpa y soluci√≥n"

  # Reglas de aprobaci√≥n
  approval_required:
    - condition: "monto mencionado > 1000‚Ç¨"
      approver: "manager"
      
    - condition: "es queja formal"
      approver: "customer_service_lead"
      
    - condition: "solicita cancelaci√≥n de contrato"
      approver: "retention_team"
      
    - condition: "contiene datos sensibles (DNI, tarjeta)"
      action: "mask_before_sending"

  # Plantillas por tipo
  templates:
    greeting_morning: "Buenos d√≠as"
    greeting_afternoon: "Buenas tardes"
    closing_formal: "Quedo a su disposici√≥n para cualquier consulta adicional"
    closing_internal: "Un saludo"
```

### 3. `rules/security_rules.yaml` - Reglas de Seguridad

```yaml
# Reglas de seguridad y cumplimiento
security_rules:

  # Filtrado de datos sensibles (PII)
  data_protection:
    mask_patterns:
      - regex: "\\b\\d{8}[A-Z]\\b"  # DNI espa√±ol
        replacement: "[DNI-MASKED]"
        
      - regex: "\\b\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}\\b"  # Tarjetas
        replacement: "[CARD-MASKED]"
        
      - regex: "\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b"  # Emails
        replacement: "[EMAIL-MASKED]"
        
      - regex: "\\b\\d{3}[\\s-]?\\d{2}[\\s-]?\\d{4}\\b"  # SSN
        replacement: "[SSN-MASKED]"

  # Validaci√≥n de salida
  output_validation:
    check_for:
      - "no incluir informaci√≥n de otros clientes"
      - "no revelar datos internos confidenciales"
      - "no prometer lo que no se puede cumplir"
      - "verificar que la firma sea correcta"
      
    blocked_recipients:
      - "*@competidor.com"
      - "*@gmail.com"  # Si solo es empresa interna
      
    max_daily_emails: 100  # L√≠mite anti-spam

  # Auditor√≠a
  audit:
    log_all: true
    retention_days: 365
    encrypt_logs: true
    log_fields:
      - timestamp
      - sender
      - subject_hash  # Hash por privacidad
      - classification
      - response_time
      - model_version
      - confidence_score
```

### 4. `rules/tone_rules.yaml` - Reglas de Tono y Estilo

```yaml
# Reglas de personalidad y tono seg√∫n contexto
tone_adaptation_rules:

  default_tone:
    formality: "formal"
    friendliness: "moderate"
    empathy: "medium"
    brevity: "concise"

  # Adaptaci√≥n por tipo de cliente
  by_client_type:
    vip:
      formality: "high"
      personalization: "use previous interactions"
      response_time: "immediate"
      signature: "dedicated_account_manager"
      
    new_lead:
      formality: "professional"
      enthusiasm: "high"
      include_cta: true  # Call to action
      
    internal:
      formality: "casual"
      brevity: "very_concise"
      skip_greeting_if_thread: true
      
    angry_customer:
      empathy: "very_high"
      apology_first: true
      solution_focused: true
      avoid_excuses: true

  # Adaptaci√≥n por canal
  by_channel:
    email:
      structure: "full_formal"
      max_paragraphs: 3
      
    teams_chat:
      structure: "brief"
      emoji_allowed: true
      
    ticket_system:
      structure: "technical"
      include_metadata: true

  # Reglas ling√º√≠sticas espec√≠ficas
  language_rules:
    es_ES:
      use_tuteo: false  # Usar 'usted' no 't√∫'
      avoid_anglicisms: true
      date_format: "DD/MM/YYYY"
      currency: "EUR"
      time_format: "24h"
```

---

## Archivos de WORKFLOWS (Flujos de Trabajo)

### 1. `workflows/main_workflow.yaml` - Flujo Principal

```yaml
# Workflow principal de procesamiento de correos
workflow:
  name: "Email AI Processor"
  version: "1.0.0"
  description: "Proceso completo desde recepci√≥n hasta env√≠o/escalamiento"

  triggers:
    - type: "schedule"
      every: "5 minutes"
    - type: "webhook"
      endpoint: "/new-email"
    - type: "manual"
      ui_button: "Procesar bandeja"

  steps:
    # Paso 1: Recepci√≥n
    - id: "fetch_emails"
      name: "Obtener correos de Exchange"
      action: "exchange_connector.fetch_unread"
      params:
        max_emails: 10
        folder: "inbox"
        mark_as_read: false  # Lo marcaremos despu√©s
      
    # Paso 2: Pre-procesamiento
    - id: "preprocess"
      name: "Limpiar y extraer metadatos"
      action: "email_processor.parse"
      depends_on: ["fetch_emails"]
      
    # Paso 3: Clasificaci√≥n
    - id: "classify"
      name: "Clasificar correo"
      action: "ai.classify"
      model: "tinyllama-classifier"
      depends_on: ["preprocess"]
      output: "category, priority, sentiment"
      
    # Paso 4: Decisi√≥n de ruta
    - id: "route"
      name: "Decidir flujo"
      action: "router.decide"
      depends_on: ["classify"]
      rules: "rules/email_rules.yaml"
      
    # Paso 5a: Procesar con IA
    - id: "generate_response"
      name: "Generar respuesta"
      action: "ai.generate"
      model: "tinyllama-responder"
      condition: "route.decision == 'auto_respond'"
      depends_on: ["route"]
      context:
        - "email_thread"
        - "customer_history"
        - "knowledge_base"
      
    # Paso 5b: Escalar a humano
    - id: "escalate"
      name: "Crear ticket para humano"
      action: "ticketing.create"
      condition: "route.decision == 'escalate'"
      depends_on: ["route"]
      
    # Paso 6: Revisi√≥n de calidad
    - id: "quality_check"
      name: "Verificar respuesta"
      action: "ai.quality_check"
      condition: "generate_response.completed"
      depends_on: ["generate_response"]
      checks:
        - "grammar"
        - "tone"
        - "security"
        - "accuracy"
      
    # Paso 7: Aprobaci√≥n humana (si es necesaria)
    - id: "human_review"
      name: "Revisi√≥n humana"
      action: "ui.show_draft"
      condition: "quality_check.score < 0.9 OR rules.require_approval"
      depends_on: ["quality_check"]
      timeout: "4 hours"
      on_timeout: "escalate"
      
    # Paso 8: Enviar
    - id: "send"
      name: "Enviar correo"
      action: "exchange_connector.send"
      condition: "quality_check.score >= 0.9 OR human_review.approved"
      depends_on: ["quality_check", "human_review"]
      
    # Paso 9: Archivar
    - id: "archive"
      name: "Archivar conversaci√≥n"
      action: "database.archive"
      depends_on: ["send", "escalate"]
      
  error_handling:
    default:
      action: "log_error"
      notify: "admin@empresa.com"
      
    on_classification_fail:
      action: "escalate_to_human"
      
    on_send_fail:
      action: "retry"
      max_retries: 3
      backoff: "exponential"
```

### 2. `workflows/email_processing.yaml` - Procesamiento Detallado

```yaml
# Sub-workflow: Procesamiento de un correo individual
workflow:
  name: "Single Email Processing"
  
  input:
    email_id: "string"
    raw_content: "string"
    metadata: "object"

  steps:
    # Extracci√≥n de informaci√≥n
    - id: "extract_entities"
      name: "Extraer entidades nombradas"
      action: "nlp.extract_entities"
      extract:
        - "person_names"
        - "organizations"
        - "dates"
        - "amounts"
        - "product_names"
        - "ticket_numbers"
      
    # An√°lisis de sentimiento
    - id: "sentiment_analysis"
      name: "Analizar sentimiento"
      action: "nlp.sentiment"
      classify:
        - "very_negative"  # Requiere atenci√≥n especial
        - "negative"
        - "neutral"
        - "positive"
        - "very_positive"
      
    # Detecci√≥n de intenci√≥n
    - id: "intent_detection"
      name: "Detectar intenci√≥n del cliente"
      action: "nlp.intent"
      possible_intents:
        - "request_information"
        - "complaint"
        - "compliment"
        - "urgent_request"
        - "cancellation"
        - "payment_issue"
        - "technical_support"
      
    # B√∫squeda en base de conocimiento
    - id: "kb_search"
      name: "Buscar informaci√≥n relevante"
      action: "knowledge_base.search"
      query: "intent + entities"
      top_k: 3
      
    # Contexto del cliente
    - id: "customer_context"
      name: "Obtener historial del cliente"
      action: "crm.get_context"
      using: "email_from_address"
      include:
        - "previous_tickets"
        - "purchase_history"
        - "satisfaction_score"
        - "preferred_language"
      
  output:
    processed_email:
      original: "{{input.raw_content}}"
      entities: "{{extract_entities.result}}"
      sentiment: "{{sentiment_analysis.result}}"
      intent: "{{intent_detection.result}}"
      kb_articles: "{{kb_search.results}}"
      customer_profile: "{{customer_context.result}}"
      suggested_priority: "auto_calculated"
```

### 3. `workflows/draft_review.yaml` - Revisi√≥n de Borradores

```yaml
# Workflow para revisi√≥n humana de borradores
workflow:
  name: "Draft Review Process"
  
  input:
    draft_id: "string"
    draft_content: "string"
    original_email: "object"
    ai_confidence: "float"

  steps:
    # Notificaci√≥n
    - id: "notify_reviewer"
      name: "Notificar al revisor"
      action: "notifications.send"
      to: "{{rules.get_reviewer(original_email)}}"
      channels:
        - "email"
        - "teams"
      content: "Nuevo borrador pendiente de revisi√≥n"
      
    # Mostrar en UI
    - id: "present_draft"
      name: "Mostrar en interfaz de revisi√≥n"
      action: "ui.render_review_screen"
      components:
        - "original_email"
        - "ai_draft"
        - "edit_tools"
        - "approve_reject_buttons"
        - "suggestions_panel"
      
    # Esperar acci√≥n humana
    - id: "await_decision"
      name: "Esperar decisi√≥n del revisor"
      action: "state.wait_for_input"
      timeout: "4 hours"
      options:
        - "approve"
        - "reject"
        - "edit_and_approve"
        - "escalate"
        
    # Si edita, guardar versi√≥n
    - id: "save_edited_version"
      name: "Guardar versi√≥n editada"
      action: "database.save"
      condition: "await_decision.choice == 'edit_and_approve'"
      
    # Si rechaza, analizar por qu√©
    - id: "analyze_rejection"
      name: "Analizar motivo de rechazo"
      action: "learning.log_feedback"
      condition: "await_decision.choice == 'reject'"
      for_improvement: true
      
    # M√©tricas
    - id: "track_metrics"
      name: "Registrar m√©tricas de revisi√≥n"
      action: "analytics.track"
      metrics:
        - "time_to_review"
        - "edit_distance"  # Cu√°nto cambi√≥ el humano
        - "approval_rate"
        - "rejection_reasons"
```

### 4. `workflows/escalation_workflow.yaml` - Escalamiento

```yaml
# Workflow cuando la IA no puede resolver
workflow:
  name: "Human Escalation"
  
  triggers:
    - "confidence_score < 0.7"
    - "sentiment == 'very_negative'"
    - "intent == 'cancellation'"
    - "category == 'legal_issue'"
    - "contains_sensitive_data == true"

  steps:
    # Crear ticket
    - id: "create_ticket"
      name: "Crear ticket en sistema"
      action: "ticketing.create"
      system: "jira"  # o ServiceNow, Zendesk, etc.
      fields:
        summary: "{{email.subject}}"
        description: "{{email.body}}"
        priority: "{{calculated_priority}}"
        labels: ["ai-escalated", "{{email.category}}"]
        
    # Asignar a agente
    - id: "assign_agent"
      name: "Asignar al mejor agente"
      action: "routing.assign"
      strategy: "round_robin"  # o "skill_based", "load_balanced"
      consider:
        - "agent_skills"
        - "current_workload"
        - "language"
        - "previous_interactions_with_customer"
        
    # Preparar contexto para humano
    - id: "prepare_context"
      name: "Preparar resumen para agente"
      action: "ai.summarize"
      include:
        - "email_thread_summary"
        - "customer_history"
        - "suggested_response"  # Lo que la IA habr√≠a dicho
        - "why_escalated"
        - "relevant_kb_articles"
        
    # Notificar
    - id: "notify_agent"
      name: "Notificar al agente asignado"
      action: "notifications.send"
      urgency: "high"
      
    # Auto-respuesta al cliente
    - id: "send_acknowledgment"
      name: "Enviar acuse de recibo"
      action: "email.send_template"
      template: "escalation_acknowledgment"
      personalize: true
      inform:
        - "ticket_number"
        - "expected_response_time"
        - "assigned_agent_name"
        
    # Seguimiento
    - id: "schedule_followup"
      name: "Programar seguimiento"
      action: "scheduler.create"
      if_not_resolved_in: "2 hours"
      action: "notify_supervisor"
```

---

## Archivos de PROMPTS

### `prompts/system_prompt.txt`

```text
Eres un asistente de correo profesional para [Nombre Empresa]. Tu objetivo es ayudar a responder correos de manera eficiente, profesional y √∫til.

REGLAS FUNDAMENTALES:
1. Siempre usa espa√±ol formal (usted) salvo indicaci√≥n contraria
2. Mant√©n las respuestas concisas (m√°ximo 3 p√°rrafos)
3. Nunca inventes informaci√≥n que no est√© en el contexto
4. Si no sabes algo, indica que escalar√°s a un humano
5. Nunca incluyas datos sensibles de otros clientes

ESTRUCTURA DE RESPUESTA:
1. Saludo personalizado
2. Reconocimiento de la consulta/problema
3. Respuesta/soluci√≥n o pr√≥ximos pasos
4. Cierre profesional

CONTEXTO DISPONIBLE:
- Historial del cliente: {{customer_history}}
- Art√≠culos relevantes: {{kb_articles}}
- Intenci√≥n detectada: {{intent}}
- Sentimiento: {{sentiment}}

Recuerda: Representas a la empresa. S√© cort√©s, profesional y solucionador.
```

### `prompts/email_classifier.txt`

```text
Clasifica el siguiente correo electr√≥nico en una de estas categor√≠as:
- CONSULTA_GENERAL
- SOPORTE_TECNICO
- VENTAS_PRESUPUESTO
- QUEJA_RECLAMACION
- FACTURACION_PAGO
- CANCELACION_BAJA
- FELICITACION
- URGENTE_CRITICO

Adem√°s, determina:
- Prioridad: BAJA, MEDIA, ALTA, CRITICA
- Sentimiento: MUY_NEGATIVO, NEGATIVO, NEUTRO, POSITIVO, MUY_POSITIVO
- Necesita aprobaci√≥n humana: SI/NO

Responde SOLO en formato JSON:
{
  "categoria": "",
  "prioridad": "",
  "sentimiento": "",
  "necesita_aprobacion": "",
  "razon": "breve explicaci√≥n"
}

Correo a clasificar:
De: {{sender}}
Asunto: {{subject}}
Contenido: {{body}}
```

---

## Archivo de Configuraci√≥n Principal (`config/config.yaml`)

```yaml
project:
  name: "Email AI Assistant"
  version: "1.0.0"
  environment: "production"  # development, staging, production

# Configuraci√≥n del modelo
model:
  name: "TinyLlama/TinyLlama-1.1B-Chat-v1.0"
  adapter_path: "./modelo_correos_final"
  quantization: "4bit"
  max_tokens: 512
  temperature: 0.7
  top_p: 0.9
  
  # Configuraci√≥n espec√≠fica por tarea
  tasks:
    classification:
      temperature: 0.1  # M√°s determinista
      max_tokens: 256
      
    generation:
      temperature: 0.7
      max_tokens: 512
      
    summarization:
      temperature: 0.3
      max_tokens: 200

# Conexi√≥n Exchange
exchange:
  server: "mail.empresa.com"
  version: "Exchange2016"
  auth_type: "NTLM"  # o "Basic", "OAuth2"
  username: "${EXCHANGE_USER}"
  password: "${EXCHANGE_PASS}"
  domain: "EMPRESA"
  
  folders:
    inbox: "Bandeja de entrada"
    processed: "Procesados_AI"
    drafts: "Borradores_AI"
    errors: "Errores_Procesamiento"
    
  polling_interval: 300  # segundos

# L√≠mites y seguridad
limits:
  max_emails_per_batch: 10
  max_daily_emails: 100
  min_confidence_threshold: 0.75
  
security:
  encrypt_logs: true
  mask_pii: true
  require_approval_for:
    - amount > 1000
    - cancellation_requests
    - legal_matters

# Integraciones
integrations:
  crm:
    enabled: true
    system: "salesforce"  # o "dynamics", "hubspot"
    
  ticketing:
    enabled: true
    system: "jira"
    
  analytics:
    enabled: true
    dashboard_url: "https://analytics.empresa.com/email-ai"

# Notificaciones
notifications:
  admin_email: "admin@empresa.com"
  error_webhook: "https://hooks.slack.com/services/..."
  
  alerts:
    on_error: true
    on_escalation: true
    daily_summary: true
```

---

## Resumen de Archivos Esenciales

| Tipo | Archivo | Prop√≥sito |
|------|---------|-----------|
| **Rules** | `email_rules.yaml` | Qu√© correos procesar/ignorar |
| **Rules** | `response_rules.yaml` | C√≥mo formatear respuestas |
| **Rules** | `security_rules.yaml` | Protecci√≥n de datos y auditor√≠a |
| **Rules** | `tone_rules.yaml` | Personalidad seg√∫n contexto |
| **Workflows** | `main_workflow.yaml` | Proceso completo paso a paso |
| **Workflows** | `email_processing.yaml` | An√°lisis detallado de correos |
| **Workflows** | `draft_review.yaml` | Revisi√≥n humana |
| **Workflows** | `escalation_workflow.yaml` | Cuando falla la IA |
| **Prompts** | `system_prompt.txt` | Instrucciones base del modelo |
| **Prompts** | `email_classifier.txt` | Clasificaci√≥n de correos |
| **Config** | `config.yaml` | Configuraci√≥n general del sistema |

¬øNecesitas que profundice en alg√∫n archivo espec√≠fico o que te ayude a implementar la integraci√≥n con Exchange on-premise?